name: Deploy Help Center Theme
on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read
  deployments: write

env: { NODE_VERSION: '20' }

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ env.NODE_VERSION }} }
      - run: |
          npm i -g @zendesk/zcli
          test -f assets/style.css || exit 1
          test -f assets/script.js || exit 1
          test -f manifest.json || exit 1
          zcli themes:validate
  deploy:
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://${{ secrets.ZENDESK_SUBDOMAIN }}.zendesk.com/hc
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: ${{ env.NODE_VERSION }} }
      - run: npm i -g @zendesk/zcli
      - name: Login Zendesk
        env:
          ZENDESK_SUBDOMAIN: ${{ secrets.ZENDESK_SUBDOMAIN }}
          ZENDESK_EMAIL:     ${{ secrets.ZENDESK_EMAIL }}
          ZENDESK_API_TOKEN: ${{ secrets.ZENDESK_API_TOKEN }}
        run: |
          zcli login --subdomain "$ZENDESK_SUBDOMAIN" --email "$ZENDESK_EMAIL" --token "$ZENDESK_API_TOKEN"
      - name: Upload theme
        env:
          BRAND_ID: ${{ secrets.ZENDESK_BRAND_ID }}
          THEME_ID: ${{ secrets.ZENDESK_THEME_ID }}
        run: |
          zcli themes:upload --brand "$BRAND_ID" --theme "$THEME_ID" --version-bump patch