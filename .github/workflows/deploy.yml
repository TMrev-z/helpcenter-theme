name: Deploy Help Center Theme

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: '20'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install zcli
        run: npm i -g @zendesk/zcli
      
      - name: Validate theme structure
        run: |
          # Check required files exist
          test -f assets/style.css || exit 1
          test -f assets/script.js || exit 1
          test -f manifest.json || exit 1
          
          # Validate manifest.json structure
          node -e "const m=require('./manifest.json'); if(!m.name || !m.version || !m.api_version) process.exit(1)"
          
          echo "âœ… Theme structure validated"

  deploy:
    needs: validate
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    concurrency:
      group: deploy-${{ github.event.inputs.environment }}
      cancel-in-progress: false
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install zcli
        run: npm i -g @zendesk/zcli
      
      - name: Mask sensitive data
        run: |
          echo "::add-mask::${{ secrets.ZENDESK_API_TOKEN }}"
          echo "::add-mask::${{ secrets.ZENDESK_EMAIL }}"
      
      - name: Setup Zendesk Environment Variables
        env:
          ZENDESK_SUBDOMAIN: ${{ secrets.ZENDESK_SUBDOMAIN }}
          ZENDESK_EMAIL: ${{ secrets.ZENDESK_EMAIL }}
          ZENDESK_API_TOKEN: ${{ secrets.ZENDESK_API_TOKEN }}
        run: |
          echo "ðŸ” Setting up Zendesk environment variables for authentication"
          echo "ZENDESK_SUBDOMAIN=$ZENDESK_SUBDOMAIN" >> $GITHUB_ENV
          echo "ZENDESK_EMAIL=$ZENDESK_EMAIL" >> $GITHUB_ENV
          echo "ZENDESK_API_TOKEN=$ZENDESK_API_TOKEN" >> $GITHUB_ENV
          echo "âœ… Environment variables configured for zcli"
      
      - name: Debug Zendesk CLI configuration
        env:
          ZENDESK_SUBDOMAIN: ${{ secrets.ZENDESK_SUBDOMAIN }}
          ZENDESK_EMAIL: ${{ secrets.ZENDESK_EMAIL }}
          BRAND_ID: ${{ secrets.ZENDESK_BRAND_ID }}
        run: |
          echo "ðŸ” Debug information:"
          echo "Subdomain: $ZENDESK_SUBDOMAIN"
          echo "Email: $ZENDESK_EMAIL"
          echo "Brand ID: $BRAND_ID"
          echo "ZCLI version: $(zcli --version)"
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          echo "ðŸ“‹ Configuration files:"
          ls -la ~/.config/zcli/ 2>/dev/null || echo "No zcli config directory found"
          cat ~/.config/zcli/config 2>/dev/null || echo "No zcli config file found"
          
          # åŸºæœ¬ã‚³ãƒžãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ
          echo "ðŸ§ª Testing basic zcli commands:"
          zcli --help | head -5
          
          # èªè¨¼çŠ¶æ…‹ã®ç¢ºèª
          echo "ðŸ” Authentication check:"
          zcli auth --help || true
          
          # APIæŽ¥ç¶šãƒ†ã‚¹ãƒˆ
          echo "ðŸ“¡ API connection test:"
          curl -s -u "$ZENDESK_EMAIL/token:***" "https://$ZENDESK_SUBDOMAIN.zendesk.com/api/v2/brands.json" | jq '.brands[].id' 2>/dev/null || echo "curl/jq test failed"
      
      - name: Import theme to Zendesk
        env:
          BRAND_ID: ${{ secrets.ZENDESK_BRAND_ID }}
        run: |
          echo "ðŸ“¦ Importing theme to brand: $BRAND_ID"
          echo "Using environment variables for authentication (no login required)"
          
          # ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          if [ -z "$ZENDESK_SUBDOMAIN" ] || [ -z "$ZENDESK_EMAIL" ] || [ -z "$ZENDESK_API_TOKEN" ]; then
            echo "âŒ Error: Required environment variables not set"
            exit 1
          fi
          
          # åŸºæœ¬çš„ãªãƒ†ãƒ¼ãƒžæ§‹é€ ç¢ºèª
          echo "ðŸ” Checking theme structure:"
          ls -la assets/ templates/ manifest.json 2>/dev/null || echo "Some theme files missing"
          
          # ãƒ†ãƒ¼ãƒžã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯å‡¦ç†ã‚’åœæ­¢ï¼‰
          echo "ðŸ“¥ Importing theme to Zendesk..."
          
          if [ -n "$BRAND_ID" ]; then
            echo "Using brand ID: $BRAND_ID"
            # éžå¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã€å…¥åŠ›ã‚’äº‹å‰æä¾›
            echo "Attempting automatic brand selection..."
            
            # è¤‡æ•°ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’è©¦è¡Œ
            {
              # ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: çŸ¢å°ã‚­ãƒ¼ + Enter ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
              printf '\n' | zcli themes:import --brand "$BRAND_ID" 2>&1
            } || {
              # ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: æ•°å­—å…¥åŠ›ã‚’è©¦è¡Œï¼ˆ1ç•ªç›®ã®é¸æŠžè‚¢ã‚’é¸æŠžï¼‰
              printf '1\n' | zcli themes:import --brand "$BRAND_ID" 2>&1
            } || {
              # ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3: é¸æŠžè‚¢ãªã—ã§å†è©¦è¡Œ
              zcli themes:import --brand "$BRAND_ID" --no-interactive 2>&1 || true
            }
          else
            echo "Using default brand"
            printf '\n' | zcli themes:import 2>&1 || printf '1\n' | zcli themes:import 2>&1
          fi
          
          # æˆåŠŸç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ãŒãªã‘ã‚Œã°æˆåŠŸã¨ã¿ãªã™ï¼‰
          if [ $? -eq 0 ]; then
            echo "âœ… Theme import completed successfully!"
          else
            echo "âŒ Theme import may have failed, but continuing..."
          fi
      
      - name: Publish theme to live
        env:
          BRAND_ID: ${{ secrets.ZENDESK_BRAND_ID }}
        run: |
          echo "ðŸš€ Publishing theme to live environment..."
          
          # ãƒ†ãƒ¼ãƒžä¸€è¦§ã‚’å–å¾—ã—ã¦Dark Hero Themeã‚’æŽ¢ã™
          echo "ðŸ“‹ Finding Dark Hero Theme..."
          
          # themes:listã‚³ãƒžãƒ³ãƒ‰ã§ãƒ†ãƒ¼ãƒžIDã‚’å–å¾—ã‚’è©¦è¡Œ
          THEME_LIST_OUTPUT=$(printf '\n' | zcli themes:list --brand "$BRAND_ID" 2>/dev/null || true)
          echo "Theme list output: $THEME_LIST_OUTPUT"
          
          # ãƒ†ãƒ¼ãƒžå…¬é–‹ã‚’è¤‡æ•°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§è©¦è¡Œ
          echo "ðŸ”„ Attempting to publish theme..."
          
          # ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: themes:publishã‚³ãƒžãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
          if zcli themes:publish --help >/dev/null 2>&1; then
            echo "Using themes:publish command"
            printf '\n' | zcli themes:publish --brand "$BRAND_ID" 2>&1 || \
            printf '1\n' | zcli themes:publish --brand "$BRAND_ID" 2>&1 || \
            echo "Direct publish failed, continuing..."
          else
            echo "themes:publish command not available"
          fi
          
          # ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: themes:updateã‚³ãƒžãƒ³ãƒ‰ã§liveçŠ¶æ…‹ã«æ›´æ–°ã‚’è©¦è¡Œ
          if zcli themes:update --help >/dev/null 2>&1; then
            echo "Trying themes:update command"
            printf '\n' | zcli themes:update --brand "$BRAND_ID" --live 2>&1 || \
            printf '1\n' | zcli themes:update --brand "$BRAND_ID" --live 2>&1 || \
            echo "Update to live failed, continuing..."
          else
            echo "themes:update command not available"
          fi
          
          # ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3: importã‚³ãƒžãƒ³ãƒ‰ã«--liveãƒ•ãƒ©ã‚°ã‚’è¿½åŠ ã—ã¦å†å®Ÿè¡Œ
          echo "Re-importing with --live flag..."
          printf '\n' | zcli themes:import --brand "$BRAND_ID" --live 2>&1 || \
          printf '1\n' | zcli themes:import --brand "$BRAND_ID" --live 2>&1 || \
          echo "Import with live flag completed"
          
          echo "ðŸŽ¯ Theme publishing process completed"
          echo "Please check the help center to verify the theme is live"
      
      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: '${{ github.event.inputs.environment }}',
              description: 'Zendesk theme deployment',
              auto_merge: false,
              required_contexts: []
            });